CREATE INDEX users_first_name_idx ON users(first_name);
CREATE INDEX users_last_name_idx ON users(last_name);
CREATE INDEX users_first_last_name_idx ON users(first_name, last_name);
CREATE INDEX users_birthday_idx ON profiles(birthday);
CREATE INDEX users_city_idx ON profiles(city);
CREATE INDEX users_country_idx ON profiles(country);
CREATE INDEX users_city_country_idx ON profiles(city, country);
CREATE INDEX community_name_idx ON communities(name);





SELECT DISTINCT
communities.name AS name, 
COUNT(communities_users.user_id) OVER() / (SELECT COUNT(*) FROM communities) AS avg_users,
FIRST_VALUE(CONCAT_WS(" ", users.first_name, users.last_name))
	OVER (w_community ORDER BY profiles.birthday DESC) AS youngest,
FIRST_VALUE(CONCAT_WS(" ", users.first_name, users.last_name))
	OVER (w_community ORDER BY profiles.birthday ASC) AS oldest,
COUNT(communities_users.user_id) OVER w_community AS users_in_group,
(SELECT COUNT(*) FROM users) AS users_total,
COUNT(communities_users.user_id) OVER w_community / (SELECT COUNT(*) FROM users) * 100 AS avgs
	FROM communities
		LEFT JOIN communities_users
			ON communities_users.community_id = communities.id
		LEFT JOIN users
			ON communities_users.user_id = users.id
		LEFT JOIN profiles
			ON profiles.user_id = users.id
		WINDOW w_community AS (PARTITION BY communities.id);

